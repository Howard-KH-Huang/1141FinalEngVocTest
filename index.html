<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¬ä¾†åœ‹å°è‹±èªå–®å­—æ¸¬é©—å¹³å°</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #FFF5E1; }
        
        /* æ’’èŠ±å‹•ç•« */
        @keyframes confetti-fall { 
            0% { transform: translateY(-10vh) rotate(0deg); } 
            100% { transform: translateY(110vh) rotate(720deg); } 
        }
        .animate-confetti-fall { animation: confetti-fall linear infinite; }
        
        /* è‡ªå®šç¾©æ²è»¸ */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #FFD166; border-radius: 10px; border: 2px solid white; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #FFB000; }
        
        /* å…¶ä»–æ¨£å¼ */
        .lucide { width: 1.5rem; height: 1.5rem; vertical-align: middle; display: inline-block; }
        .text-shadow { text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* é€²åº¦æ¢å‹•ç•« */
        .progress-bar-fill { transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- é…ç½®å€ ---
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwsxMCSMVvzWtSe46HVwXoPFQyLiXyOUVLCr4HKqZ3ZZLZoDUJkOiCvQrdxPhur2Vdydw/exec";
        const apiKey = ""; 

        const WORD_BANK = [
            { en: "gap", zh: "é–“éš™" }, { en: "gut", zh: "è…¸é“" }, { en: "cap", zh: "é´¨èˆŒå¸½" },
            { en: "cut", zh: "åˆ‡;å‰ª" }, { en: "gum", zh: "å£é¦™ç³–" }, { en: "cat", zh: "è²“" },
            { en: "gas", zh: "ç“¦æ–¯" }, { en: "cop", zh: "è­¦å¯Ÿ" }, { en: "Van", zh: "ç®±å‹è»Š" },
            { en: "vest", zh: "èƒŒå¿ƒ" }, { en: "fan", zh: "é›»é¢¨æ‰‡" }, { en: "fest", zh: "ç¯€æ—¥" },
            { en: "vat", zh: "æ¡¶" }, { en: "fat", zh: "èƒ–çš„" }, { en: "vet", zh: "ç¸é†«" },
            { en: "fox", zh: "ç‹ç‹¸" }, { en: "zip", zh: "æ‹‰éŠ" }, { en: "Zack", zh: "ç”·å­å" },
            { en: "sip", zh: "å•œé£²" }, { en: "sack", zh: "éº»å¸ƒè¢‹" }, { en: "zit", zh: "ç—˜ç—˜;ç–¹å­" },
            { en: "sit", zh: "åä¸‹" }, { en: "zag", zh: "æ€¥è½‰" }, { en: "sun", zh: "å¤ªé™½" },
            { en: "where", zh: "å“ªè£¡" }, { en: "bathroom", zh: "æµ´å®¤" }, { en: "bedroom", zh: "è‡¥æˆ¿" },
            { en: "kitchen", zh: "å»šæˆ¿" }, { en: "dining room", zh: "é£¯å»³" }, { en: "living room", zh: "å®¢å»³" },
            { en: "bird", zh: "é³¥" }, { en: "rabbit", zh: "å…”å­" }, { en: "turtle", zh: "çƒé¾œ" },
            { en: "dog", zh: "ç‹—" }, { en: "fish", zh: "é­š" }, { en: "house", zh: "æˆ¿å­" },
            { en: "friend", zh: "æœ‹å‹" }, { en: "bat", zh: "è™è " }, { en: "ghost", zh: "é¬¼" },
            { en: "jack-o'-lantern", zh: "å—ç“œç‡ˆ" }, { en: "spider", zh: "èœ˜è››" },
            { en: "Trick or treat.", zh: "ä¸çµ¦ç³–å°±æ—è›‹" }, { en: "Happy Halloween.", zh: "è¬è–ç¯€å¿«æ¨‚" },
            { en: "ready", zh: "æº–å‚™å¥½çš„" }, { en: "Good job.", zh: "åšçš„å¥½" }, { en: "Welcome.", zh: "æ­¡è¿ã€‚" },
            { en: "Good afternoon.", zh: "åˆå®‰ã€‚" }, { en: "It's tea time.", zh: "å–èŒ¶æ™‚é–“åˆ°äº†" },
            { en: "Please help yourself.", zh: "è«‹è‡ªä¾¿ã€‚" }
        ];

        const SPELLING_WORDS_LIST = ["gap", "gut", "cap", "cut", "gum", "cat", "gas", "cop", "van", "vest", "fan", "fest", "vat", "fat", "vet", "fox", "zip", "Zack", "sip", "sack", "zit", "sit", "zag", "sun", "where", "bathroom", "bedroom", "kitchen", "dining room", "living room", "bird", "rabbit", "turtle", "dog", "fish", "house", "friend", "bat", "ghost", "spider", "ready"];

        // ç©©å®šçš„åœ–ç¤ºå…ƒä»¶
        const LucideIcon = ({ name, className = "" }) => {
            const iconRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iconRef.current) {
                    iconRef.current.innerHTML = `<i data-lucide="${name}" class="${className}"></i>`;
                    window.lucide.createIcons({ root: iconRef.current });
                }
            }, [name, className]);
            return <span ref={iconRef} className="inline-flex items-center justify-center min-w-[1.5rem] min-h-[1.5rem]"></span>;
        };

        // æ’’èŠ±å…ƒä»¶
        const ConfettiRain = () => {
            const pieces = Array.from({ length: 80 });
            const dopamineColors = ['#FF9A9E', '#FAD0C4', '#FBC2EB', '#A18CD1', '#84FAB0', '#8FD3F4', '#FFD166', '#06D6A0'];
            return (
                <div className="fixed inset-0 pointer-events-none z-[100] overflow-hidden">
                    {pieces.map((_, i) => (
                        <div key={i} className="absolute animate-confetti-fall"
                            style={{ 
                                left: `${Math.random() * 100}%`, 
                                backgroundColor: dopamineColors[Math.floor(Math.random() * dopamineColors.length)], 
                                width: `${Math.random() * 12 + 6}px`, 
                                height: `${Math.random() * 12 + 6}px`, 
                                borderRadius: Math.random() > 0.5 ? '50%' : '2px', 
                                animationDelay: `${Math.random() * 5}s`, 
                                animationDuration: `${Math.random() * 3 + 2}s`, 
                                opacity: Math.random() * 0.5 + 0.5 
                            }}
                        />
                    ))}
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('INFO');
            const [studentInfo, setStudentInfo] = useState({ class: '', seat: '', name: '' });
            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]);
            const [score, setScore] = useState(0);
            const [isAudioLoading, setIsAudioLoading] = useState(false);
            const [spellingInput, setSpellingInput] = useState('');
            const [tempSelection, setTempSelection] = useState(null);
            const [showConfetti, setShowConfetti] = useState(false);
            const [playCounts, setPlayCounts] = useState(new Array(20).fill(0));
            const [timeLeft, setTimeLeft] = useState(900);
            const [dbRowIndex, setDbRowIndex] = useState(null);
            const [isSyncing, setIsSyncing] = useState(false);
            const [leaderboard, setLeaderboard] = useState([]);
            const [isLoadingLeaderboard, setIsLoadingLeaderboard] = useState(true);

            const timerRef = useRef(null);
            const inputRef = useRef(null);

            useEffect(() => { fetchLeaderboard(); }, []);

            // é å…ˆè¼‰å…¥èªéŸ³åˆ—è¡¨
            useEffect(() => {
                const loadVoices = () => {
                    const voices = window.speechSynthesis.getVoices();
                };
                loadVoices();
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                }
            }, []);

            useEffect(() => {
                if (gameState === 'RESULT' && score >= 60) {
                    setShowConfetti(true);
                    const timer = setTimeout(() => { setShowConfetti(false); }, 10000);
                    return () => clearTimeout(timer);
                }
            }, [gameState, score]);

            useEffect(() => {
                if (gameState === 'QUIZ') {
                    timerRef.current = setInterval(() => {
                        setTimeLeft(prev => {
                            if (prev <= 0) return 0;
                            return prev - 1;
                        });
                    }, 1000);
                }
                return () => clearInterval(timerRef.current);
            }, [gameState]);

            useEffect(() => {
                if (timeLeft === 0 && gameState === 'QUIZ') {
                    clearInterval(timerRef.current);
                    finishQuiz(score, userAnswers, 0); 
                }
            }, [timeLeft, gameState, score, userAnswers, dbRowIndex]);

            useEffect(() => {
                if (gameState === 'QUIZ' && questions[currentIndex]) {
                    const q = questions[currentIndex];
                    if (q.type === 'SPELLING' || q.type === 'LISTENING_SELECT') {
                        const timer = setTimeout(() => {
                            triggerAutoPlay(q.en);
                        }, 500);
                        return () => clearTimeout(timer);
                    }
                }
            }, [currentIndex, gameState]);

            const fetchLeaderboard = async () => {
                try {
                    setIsLoadingLeaderboard(true);
                    const res = await fetch(SCRIPT_URL);
                    const data = await res.json();
                    const filteredData = (data.leaderboard || []).filter(entry => entry.score >= 60);
                    setLeaderboard(filteredData);
                } catch { 
                    setLeaderboard([]);
                } finally { 
                    setIsLoadingLeaderboard(false); 
                }
            };

            const getEncouragement = (s) => {
                if (s === 100) return "å®Œç¾é”æˆï¼ä½ æ˜¯è‹±èªå–®å­—å°è¶…äººï¼Œç²å¾—æ»¿åˆ†æ¦®è­½ï¼ğŸ†";
                if (s >= 90) return "è¶…ç¾¤çµ•å€«ï¼è¡¨ç¾éå¸¸å„ªç§€ï¼Œé›¢æ»¿åˆ†åªå‰©ä¸€æ­¥ä¹‹é™ï¼âœ¨";
                if (s >= 80) return "è¡¨ç¾å„ªç•°ï¼ä½ å°å–®å­—éå¸¸ç†Ÿæ‚‰ï¼Œç¹¼çºŒä¿æŒé€™è‚¡æ°£å‹¢ï¼ğŸ‘";
                if (s >= 70) return "åšå¾—å¥½ï¼ä½ å·²ç¶“æŒæ¡å¤§éƒ¨åˆ†å–®å­—äº†ï¼Œå†åŠ æ²¹ä¸€é»é»ï¼ğŸ’ª";
                if (s >= 60) return "å¤ªæ£’äº†ï¼åŠæ ¼å›‰ï¼æœ‰é€²æ­¥çš„ç©ºé–“ï¼Œä¸‹æ¬¡æŒ‘æˆ°æ›´é«˜åˆ†ï¼ğŸ˜Š";
                return "åˆ¥æ°£é¤’ï¼å†å¤šç·´ç¿’ä¸€ä¸‹ï¼Œä¸‹æ¬¡ä¸€å®šå¯ä»¥åŠæ ¼çš„ï¼ŒåŠ æ²¹ï¼ğŸ”¥";
            };

            const formatDurationChinese = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}åˆ†${secs}ç§’`;
            };

            const formatTimeDisplay = (s) => `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;

            // ä½¿ç”¨ç€è¦½å™¨å…§å»º TTS (é‡å° iOS/Android/Chromebook å„ªåŒ–)
            const speakText = (text) => {
                return new Promise((resolve, reject) => {
                    if (!window.speechSynthesis) {
                        return reject("No TTS");
                    }
                    
                    window.speechSynthesis.cancel();

                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'en-US'; 
                    utterance.rate = 0.8; 

                    const voices = window.speechSynthesis.getVoices();
                    // iOS å„ªå…ˆé¸æ“‡ Samanthaï¼ŒAndroid/Chrome é¸æ“‡ Google US Englishï¼Œå…¶æ¬¡æ˜¯ä»»ä½•åŒ…å« Enhanced çš„èªéŸ³
                    let preferredVoice = voices.find(v => v.name === 'Samantha'); 
                    
                    if (!preferredVoice) {
                        preferredVoice = voices.find(v => v.name.includes('Samantha'));
                    }
                    
                    if (!preferredVoice) {
                        preferredVoice = voices.find(v => v.name === 'Google US English');
                    }

                    if (!preferredVoice) {
                         preferredVoice = voices.find(v => v.lang === 'en-US' && v.name.includes('Enhanced'));
                    }
                    
                    if (!preferredVoice) {
                         preferredVoice = voices.find(v => ['Aaron', 'Fred', 'Nicky'].includes(v.name));
                    }

                    if (!preferredVoice) {
                        preferredVoice = voices.find(v => v.lang === 'en-US');
                    }
                    
                    if (preferredVoice) {
                        utterance.voice = preferredVoice;
                    }
                    
                    utterance.onend = () => {
                        resolve();
                    };
                    
                    utterance.onerror = (e) => {
                        console.error("TTS Error:", e);
                        resolve();
                    };

                    setTimeout(() => {
                         window.speechSynthesis.speak(utterance);
                    }, 10);
                });
            };

            const warmUpTTS = () => {
                if (window.speechSynthesis) {
                    const utterance = new SpeechSynthesisUtterance('');
                    window.speechSynthesis.speak(utterance);
                }
            };

            const triggerAutoPlay = async (word) => {
                if (isAudioLoading) return;
                setIsAudioLoading(true);
                await speakText(word);
                setIsAudioLoading(false);
                if (inputRef.current) inputRef.current.focus();
            };

            const playAudioManually = async () => {
                if (isAudioLoading || playCounts[currentIndex] >= 2) return;
                setIsAudioLoading(true);
                try {
                    await speakText(questions[currentIndex].en);
                    const newCounts = [...playCounts];
                    newCounts[currentIndex] += 1;
                    setPlayCounts(newCounts);
                } catch (e) {
                    console.error("Play failed", e);
                }
                setIsAudioLoading(false);
                if (inputRef.current) inputRef.current.focus();
            };

            const startQuiz = async () => {
                if (!studentInfo.class || !studentInfo.seat || !studentInfo.name) {
                    alert("è«‹å®Œæ•´å¡«å¯«ç­ç´šã€åº§è™Ÿèˆ‡å§“åï¼");
                    return;
                }
                
                warmUpTTS();

                setIsSyncing(true);
                try {
                    const res = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action: 'start', ...studentInfo }) });
                    const data = await res.json();
                    setDbRowIndex(data.rowIndex);
                } catch {}
                
                const shuffled = [...WORD_BANK].sort(() => Math.random() - 0.5);
                const spellingPool = WORD_BANK.filter(w => SPELLING_WORDS_LIST.includes(w.en)).sort(() => Math.random() - 0.5);
                const qSpelling = spellingPool.slice(0, 5).map(w => ({ ...w, type: 'SPELLING', section: 'ç¬¬ä¸‰å¤§é¡Œï¼šè½éŸ³æ‹¼å­—' }));
                const pickedEn = new Set(qSpelling.map(w => w.en));
                const remaining = shuffled.filter(w => !pickedEn.has(w.en));
                const qListen = remaining.slice(0, 5).map(w => ({ 
                    ...w, type: 'LISTENING_SELECT', section: 'ç¬¬ä¸€å¤§é¡Œï¼šè½éŸ³é¸å­—',
                    options: [...WORD_BANK.filter(x => x.en !== w.en).sort(() => Math.random() - 0.5).slice(0, 3).map(x => x.en), w.en].sort(() => Math.random() - 0.5)
                }));
                const qText = remaining.slice(5, 15).map(w => ({ 
                    ...w, type: 'TEXT', section: 'ç¬¬äºŒå¤§é¡Œï¼šçœ‹è‹±é¸ä¸­',
                    options: [...WORD_BANK.filter(x => x.en !== w.en).sort(() => Math.random() - 0.5).slice(0, 3).map(x => x.zh), w.zh].sort(() => Math.random() - 0.5)
                }));

                setQuestions([...qListen, ...qText, ...qSpelling]);
                setGameState('QUIZ');
                setIsSyncing(false);
            };

            const finishQuiz = async (fScore, fAnswers, remainingTime) => {
                setGameState('RESULT');
                setIsSyncing(true);
                if (dbRowIndex) {
                    const durationSec = 900 - remainingTime;
                    const dur = formatDurationChinese(durationSec);
                    await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'end', rowIndex: dbRowIndex, score: fScore, duration: dur, errors: fAnswers.filter(a => !a.isCorrect).map(a => a.en).join(', ') })
                    });
                }
                setIsSyncing(false);
                fetchLeaderboard();
            };

            const confirm = () => {
                const q = questions[currentIndex];
                const userVal = q.type === 'SPELLING' ? spellingInput.trim() : tempSelection;
                const isCorrect = q.type === 'SPELLING' ? userVal.toLowerCase() === q.en.toLowerCase() : (q.type === 'TEXT' ? userVal === q.zh : userVal === q.en);
                const newAns = [...userAnswers, { en: q.en, selected: userVal, isCorrect, section: q.section, type: q.type, correct: q.type === 'TEXT' ? q.zh : q.en }];
                const newScore = isCorrect ? score + 5 : score;
                setUserAnswers(newAns);
                setScore(newScore);
                setSpellingInput('');
                setTempSelection(null);
                if (currentIndex < 19) setCurrentIndex(currentIndex + 1);
                else finishQuiz(newScore, newAns, timeLeft);
            };

            return (
                <div class="h-dvh flex items-center justify-center p-4">
                    {showConfetti && <ConfettiRain />}
                    
                    <div class="max-w-xl w-full bg-white rounded-[2rem] md:rounded-[2.5rem] shadow-2xl overflow-hidden border-8 border-white ring-1 ring-pink-100 flex flex-col h-full md:h-auto max-h-[95dvh]">
                        {/* Header */}
                        <div class="shrink-0 relative">
                            <div class="bg-gradient-to-br from-[#FF416C] via-[#FF4B2B] to-[#FF8C00] p-6 text-center text-white relative overflow-hidden">
                                <LucideIcon name="sparkles" className="absolute top-4 right-4 opacity-30 w-10 h-10 animate-pulse" />
                                <h1 class="text-xl md:text-2xl font-black drop-shadow-md text-shadow">è¬ä¾†åœ‹å°è‹±èªå–®å­—æ¸¬é©—å¹³å°</h1>
                                <p class="mt-2 bg-black/20 px-3 py-1 rounded-full inline-block text-xs font-bold border border-white/20">114-1_å››å¹´ç´šè‹±èªç¬¬äºŒæ¬¡è©•é‡å–®å­—</p>
                            </div>
                            
                            {gameState === 'QUIZ' && (
                                <div class="h-4 bg-slate-100 w-full relative shadow-inner">
                                    <div class="progress-bar-fill h-full bg-gradient-to-r from-pink-400 via-yellow-400 to-green-400 shadow-[0_0_10px_rgba(255,209,102,0.5)]"
                                         style={{ width: `${(currentIndex / 20) * 100}%` }}>
                                    </div>
                                    <div class="absolute inset-0 flex items-center justify-center text-[10px] font-black text-slate-500 uppercase tracking-tighter">
                                        Progress: {currentIndex} / 20
                                    </div>
                                </div>
                            )}
                        </div>

                        <div class="flex-1 overflow-y-auto custom-scrollbar p-6 md:p-8">
                        {gameState === 'INFO' ? (
                            <div class="space-y-6 text-center animate-in fade-in duration-500">
                                <div class="bg-[#E0F7FA] w-16 h-16 rounded-3xl flex items-center justify-center mx-auto mb-4 rotate-3 shadow-sm">
                                    <LucideIcon name="graduation-cap" className="text-[#00ACC1] w-10 h-10" />
                                </div>
                                <div class="space-y-4">
                                    <div class="flex gap-3">
                                        <input class="flex-1 p-4 rounded-2xl border-4 border-[#F3E5F5] outline-none font-bold text-center text-lg" placeholder="ç­ç´š" value={studentInfo.class} onChange={e => setStudentInfo({...studentInfo, class: e.target.value})} />
                                        <input class="w-24 p-4 rounded-2xl border-4 border-[#FFF3E0] outline-none font-bold text-center text-lg" placeholder="åº§è™Ÿ" type="number" inputMode="numeric" value={studentInfo.seat} onChange={e => setStudentInfo({...studentInfo, seat: e.target.value})} />
                                    </div>
                                    <input class="w-full p-4 rounded-2xl border-4 border-[#E8F5E9] outline-none font-bold text-center text-lg" placeholder="å§“å" value={studentInfo.name} onChange={e => setStudentInfo({...studentInfo, name: e.target.value})} />
                                </div>
                                <button onClick={startQuiz} disabled={isSyncing} class="w-full bg-[#FF6B6B] py-4 md:py-5 rounded-3xl text-white font-black text-xl shadow-lg active:scale-95 transition-all tap-highlight-transparent">
                                    {isSyncing ? "åŒæ­¥ä¸­..." : "å‡ºç™¼å›‰ï¼"}
                                </button>
                                
                                <div class="pt-6 border-t-2 border-dashed border-slate-100">
                                    <h3 class="text-[#FFA000] font-black uppercase flex items-center justify-center gap-2 mb-4"><LucideIcon name="crown" className="w-5 h-5" /> æ¦®è­½æ’è¡Œæ¦œ (Top 10)</h3>
                                    {isLoadingLeaderboard ? <div class="animate-pulse text-slate-300 font-bold py-10">è¼‰å…¥æ’è¡Œæ¦œä¸­...</div> : 
                                    <div class="bg-white rounded-3xl border-4 border-slate-50 overflow-hidden text-xs mx-auto w-full">
                                        <table class="w-full">
                                            <thead class="bg-slate-50 text-slate-400 uppercase tracking-widest font-black text-[9px]"><tr><th class="p-3">#</th><th class="p-3 text-left">å§“å</th><th class="p-3">å¾—åˆ†</th><th class="p-3 text-right">ä½œç­”æ™‚é–“</th></tr></thead>
                                            <tbody class="font-bold">
                                                {leaderboard.map((e,i)=>(<tr key={i} class="border-t border-slate-50 hover:bg-slate-50/50 transition-colors"><td class="p-3 text-center">{i === 0 ? "ğŸ†" : i === 1 ? "ğŸ¥ˆ" : i === 2 ? "ğŸ¥‰" : i + 1}</td>
                                                <td class="p-3 text-left">
                                                    <div class="text-slate-700 truncate max-w-[80px] text-sm">{e.name}</div>
                                                    <div class="text-[10px] text-slate-400 font-normal">{e.class}</div>
                                                </td>
                                                <td class="p-3 text-center text-red-500 font-black text-sm">{e.score}</td><td class="p-3 text-right text-slate-400 text-[10px]">{e.durationDisplay}</td></tr>))}
                                            </tbody>
                                        </table>
                                    </div>}
                                </div>
                            </div>
                        ) : gameState === 'QUIZ' ? (
                            <div class="space-y-6">
                                <div class="flex justify-between items-center">
                                    <span class="bg-[#FFE082] text-[#FF8F00] px-3 py-1 rounded-lg font-black text-[10px] uppercase">{questions[currentIndex].section.split('ï¼š')[0]}</span>
                                    <div class="flex items-center gap-2 text-orange-600 font-black px-3 py-1 bg-orange-50 rounded-xl text-sm">
                                        <LucideIcon name="clock" className="w-4 h-4" />
                                        {formatTimeDisplay(timeLeft)}
                                    </div>
                                </div>
                                <div class="bg-slate-50 p-4 md:p-6 rounded-[2rem] text-center border-4 border-slate-100 shadow-inner min-h-[160px] flex flex-col items-center justify-center">
                                    {questions[currentIndex].type !== 'TEXT' ? (
                                        <div class="space-y-4 w-full">
                                            <button onClick={playAudioManually} disabled={playCounts[currentIndex] >= 2 || isAudioLoading} class={`p-6 md:p-8 rounded-full border-8 border-white shadow-lg transition-all active:scale-95 touch-manipulation ${playCounts[currentIndex] >= 2 ? 'bg-slate-200 grayscale shadow-none' : 'bg-[#FFD166]'}`}>
                                                <LucideIcon name={playCounts[currentIndex] >= 2 ? "ban" : (isAudioLoading ? "loader-2" : "volume-2")} className={`w-10 h-10 md:w-12 md:h-12 text-white ${isAudioLoading ? 'animate-spin' : ''}`} />
                                            </button>
                                            <div class="flex flex-col gap-1 items-center">
                                                <div class="px-3 py-1 rounded-full font-black text-[10px] md:text-xs inline-block bg-[#FFF9C4] text-[#FFA000]">é‡æ’­æ¬¡æ•¸å‰©é¤˜: {2 - playCounts[currentIndex]} / 2</div>
                                                <p class="text-[9px] text-slate-300 font-bold italic">é¡Œç›®å‡ºç¾æ™‚å·²è‡ªå‹•ç‚ºæ‚¨æ’­æ”¾ä¸€æ¬¡</p>
                                            </div>
                                        </div>
                                    ) : <h2 class="text-4xl md:text-5xl font-black text-slate-800 tracking-tighter leading-tight break-words px-2">{questions[currentIndex].en}</h2>}
                                </div>
                                {questions[currentIndex].type === 'SPELLING' ? (
                                    <div class="space-y-4">
                                        <input ref={inputRef} class="w-full p-4 md:p-5 text-2xl md:text-3xl text-center font-black border-4 border-[#D1C4E9] rounded-3xl outline-none uppercase bg-[#EDE7F6]/30 focus:border-[#673AB7] transition-all" placeholder="åœ¨æ­¤æ‹¼å­—" value={spellingInput} onChange={e => setSpellingInput(e.target.value)} onKeyPress={e => e.key === 'Enter' && confirm()} enterkeyhint="done" />
                                        <button onClick={confirm} disabled={!spellingInput.trim()} class="w-full bg-[#06D6A0] py-4 md:py-5 rounded-3xl text-white font-black text-xl shadow-md active:scale-95 transition-all touch-manipulation">ç¢ºèªé€å‡º</button>
                                    </div>
                                ) : (
                                    <div class="space-y-4">
                                        <div class="grid grid-cols-1 gap-3">
                                            {questions[currentIndex].options.map((opt, i) => (
                                                <button key={i} onClick={() => setTempSelection(opt)} class={`p-4 text-left rounded-2xl border-b-4 font-black transition-all flex items-center gap-3 touch-manipulation ${tempSelection === opt ? 'bg-orange-400 border-orange-600 text-white translate-y-1 border-b-0 ring-4 ring-orange-100 shadow-inner' : 'bg-slate-100 border-slate-300 active:bg-slate-200'}`}>
                                                    <span class={`w-8 h-8 flex-shrink-0 flex items-center justify-center rounded-lg font-black ${tempSelection === opt ? 'bg-white text-orange-400' : 'bg-slate-200'}`}>{String.fromCharCode(65+i)}</span>
                                                    <span class="text-lg">{opt}</span>
                                                </button>
                                            ))}
                                        </div>
                                        <button onClick={confirm} disabled={!tempSelection} class="w-full bg-[#FF6B6B] py-4 md:py-5 rounded-3xl text-white font-black text-xl shadow-md active:scale-95 disabled:bg-slate-200 transition-all touch-manipulation">ç¢ºå®šç­”æ¡ˆ</button>
                                    </div>
                                )}
                            </div>
                        ) : (
                            <div class="text-center space-y-6 animate-in fade-in zoom-in duration-500">
                                <div class="bg-yellow-50 w-24 h-24 rounded-full flex items-center justify-center mx-auto shadow-inner">
                                    <LucideIcon name="trophy" className="w-14 h-14 text-[#FBC02D] animate-bounce" />
                                </div>
                                <div class="px-2">
                                    <h2 class="text-xl md:text-2xl font-black text-slate-800 tracking-tighter leading-tight">
                                        {getEncouragement(score)}
                                    </h2>
                                </div>
                                <div class="bg-indigo-600 p-6 rounded-[2rem] text-white shadow-xl">
                                    <p class="opacity-80 text-xs font-bold uppercase tracking-widest">{studentInfo.class} / {studentInfo.seat} è™Ÿ</p>
                                    <h3 class="text-2xl font-black tracking-tight truncate">{studentInfo.name}</h3>
                                    <h4 class="text-5xl font-black mt-2 leading-none">{score} PTS</h4>
                                </div>
                                {isSyncing && <div class="text-indigo-600 font-bold animate-pulse text-sm flex items-center justify-center gap-2"><LucideIcon name="loader-2" className="animate-spin w-4 h-4" /> æˆç¸¾æ›´æ–°ä¸­...</div>}
                                
                                {/* ç­”é¡Œå›é¡§å€åŸŸ */}
                                <div className="space-y-4">
                                    <h3 class="text-sm font-black text-slate-400 uppercase tracking-widest border-b-2 border-slate-100 pb-2">ç­”é¡Œå›é¡§</h3>
                                    <div class="max-h-64 overflow-y-auto pr-2 space-y-3 custom-scrollbar px-1">
                                        {userAnswers.map((ans, i) => (
                                            <div key={i} className={`flex items-center justify-between p-4 rounded-3xl border-2 bg-white transition-shadow hover:shadow-md ${ans.isCorrect ? 'border-[#81C784] bg-green-50/20' : 'border-[#EF9A9A] bg-red-50/20'}`}>
                                                {/* å·¦å´ï¼šé¡Œç›®å…§å®¹ */}
                                                <div className="text-left flex-1 min-w-0 mr-4">
                                                    <div className="flex items-center gap-2">
                                                        <span className="font-black text-slate-700 truncate text-lg">{ans.en}</span>
                                                        {ans.type === 'SPELLING' && <LucideIcon name="keyboard" className="w-4 h-4 text-slate-400 flex-shrink-0" />}
                                                        {ans.type === 'LISTENING_SELECT' && <LucideIcon name="headphones" className="w-4 h-4 text-slate-400 flex-shrink-0" />}
                                                        {ans.type === 'TEXT' && <LucideIcon name="list-ordered" className="w-4 h-4 text-slate-400 flex-shrink-0" />}
                                                    </div>
                                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-tighter">{ans.section.split('ï¼š')[1]}</p>
                                                </div>

                                                {/* å³å´ï¼šå›é¥‹èˆ‡æ­£è§£ */}
                                                <div className="flex items-center gap-3 shrink-0">
                                                    {!ans.isCorrect ? (
                                                        <div className="flex flex-col items-end">
                                                            <div className="flex items-center gap-1 mb-1">
                                                                <span className="text-[10px] font-bold text-slate-400">ä½ çš„ç­”æ¡ˆ:</span>
                                                                <span className="text-xs font-bold text-[#F44336] line-through decoration-2">{ans.selected}</span>
                                                            </div>
                                                            <div className="flex items-center gap-1 bg-[#4CAF50]/10 px-2 py-1 rounded-lg">
                                                                <span className="text-[10px] font-bold text-[#4CAF50]">æ­£è§£:</span>
                                                                <span className="text-sm font-black text-[#4CAF50]">{ans.correct}</span>
                                                            </div>
                                                        </div>
                                                    ) : (
                                                        <div className="hidden md:flex items-center gap-1 bg-[#4CAF50]/10 px-3 py-1 rounded-full">
                                                             <span className="text-sm font-black text-[#4CAF50]">Correct!</span>
                                                        </div>
                                                    )}
                                                    {ans.isCorrect ? <LucideIcon name="check-circle-2" className="w-8 h-8 text-[#4CAF50] drop-shadow-sm flex-shrink-0" /> : <LucideIcon name="x-circle" className="w-8 h-8 text-[#F44336] drop-shadow-sm flex-shrink-0" />}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>

                                <button onClick={() => window.location.reload()} class="w-full bg-slate-900 py-4 md:py-5 rounded-3xl text-white font-black text-xl shadow-lg hover:bg-black active:scale-95 transition-all flex items-center justify-center gap-2 touch-manipulation"><LucideIcon name="refresh-ccw" className="w-6 h-6" /> å†æˆ°ä¸€å ´ï¼</button>
                            </div>
                        )}
                        </div>

                        <div class="p-4 bg-white/80 backdrop-blur-md text-center border-t border-slate-100 shrink-0">
                            <p class="text-[#FF9A9E] text-[10px] font-black uppercase tracking-[0.2em] flex items-center justify-center gap-2">
                                <span class="w-2 h-2 rounded-full bg-pink-400 animate-ping"></span>
                                Wanlai Elementary School â€¢ 114-1_Vocabulary Quiz System
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
